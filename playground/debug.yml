---

- name: Create Kubernetes master node
  hosts: master
  become: yes
  gather_facts: false
  roles:
    - prelude
  tasks:

    - name: Init k8s
      shell: kubeadm init --apiserver-advertise-address 192.168.56.111 --pod-network-cidr=10.240.0.0/16

    - name: Setup flannel
      shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant

    - name: Copy admin config
      copy:
        src: /etc/kubernetes/admin.conf
        remote_src: true
        dest: /home/vagrant/.kube/config
        owner: vagrant
        group: vagrant

    # - name: download flannel
      # ansible.builtin.get_url:
        # url: https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
        # dest: ~/flannel.yaml
        # mode: '0664'
#
    # - name: Apply flannel
      # kubernetes.core.k8s:
        # kubeconfig: /etc/kubernetes/admin.conf
        # state: present
        # src: ~/flannel.yaml
